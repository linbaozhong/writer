<!DOCTYPE html>

<html>

	<head>
		<title>非线性协作</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<link rel="stylesheet" type="text/css" href="/static/css/jquery-ui.css" />
		<link rel="stylesheet" type="text/css" href="/static/css/iconFont.min.css" />
		<link rel="stylesheet" type="text/css" href="/static/css/metro-bootstrap.min.css" />
		<script src="/static/js/jquery-2.1.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/static/js/jquery.cookie.js" type="text/javascript" charset="utf-8"></script>
		<script src="/static/js/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/static/js/jquery.mousewheel.js" type="text/javascript"></script>
		<!-- 代码高亮显示 -->
		<script type="text/javascript" charset="utf-8" src="/static/js/third-party/SyntaxHighlighter/shCore.js"></script>
		<script type="text/javascript" charset="utf-8" src="/static/js/third-party/SyntaxHighlighter/shAutoloader.js"></script>
		<link rel="stylesheet" type="text/css" href="/static/js/third-party/SyntaxHighlighter/styles/shCoreDefault.css" />
		<link rel="stylesheet" type="text/css" href="/static/js/third-party/SyntaxHighlighter/styles/shThemeEmacs.css" />
		<script type="text/javascript" charset="utf-8" src="/static/js/third-party/SyntaxHighlighter/scripts/shBrushJScript.js"></script>
		<!--滚动条-->
		<link rel="stylesheet" type="text/css" href="/static/css/jquery.mCustomScrollbar.min.css" />
		<script src="/static/js/jquery.accordion.0.1.js" type="text/javascript" charset="utf-8"></script>
		<!--<script src="/static/js/metro-loader.js" type="text/javascript" charset="utf-8"></script>-->
		<link rel="stylesheet" type="text/css" href="/static/css/index.css" />
	</head>

	<body class="metro">
		<!--左侧导航条-->
		<nav id="nav-left" class="bg-dark">
			<a href="/"><div id="logo" class="text-center fg-white">
				参考书
			</div></a>
			<div id="tags" class="fg-white text-bold" style="margin:0;padding:0;">

			</div>
		</nav>

		<!--右侧导航条-->
		<nav id="nav-right" class="bg-dark fg-white shadow">
			<ul style="margin:0;padding:0;">
				<li id="login" class="" style="display:none;" data-hint="登录" data-hint-position="left" data-click="transform" data-role="1" data-rel="signin">
					<div class="icon">
						<i class="icon-key-2"></i>
					</div>
					<div class="small-size">
						登录
					</div>
				</li>
				<li id="avatar" class="snow-profile image-container" style="height: 90px;display:none;" data-hint="" data-hint-position="left" data-click="transform" data-role="1" data-rel="">
					<img src="" class="cycle"  />
					<div class="nickname"  style="color:#fff !important">
					</div>
				</li>
				<li id="logout" class="snow-profile" style="display:none;" data-hint="注销" data-hint-position="left" data-click="transform" data-role="1" data-rel="">
					<div class="icon">
						<i class="icon-exit"></i>
					</div>
					<div class="small-size">
						注销
					</div>
				</li>
				<li class="snow-profile" style="display:none;" data-hint="收藏夹" data-hint-position="left" data-click="transform" data-role="0" data-rel="bookmarks">
					<div class="icon">
						<i class="icon-bookmark-4"></i>
					</div>
					<div>
						收藏夹
					</div>
				</li>
				<li class="snow-profile" style="display:none;" data-hint="笔记" data-hint-position="left" data-click="transform" data-role="0" data-rel="bookmarks">
					<div class="icon">
						<i class="icon-clipboard-2"></i>
					</div>
					<div>
						笔记
					</div>
				</li>
				<li id="snow-lang" class="">
					<div class="icon">
						<i class="icon-location-3"></i>
					</div>
					<div class="snow-lang-name">
						中文
					</div>
					<div class="snow-languages">
						<a href="?lang=">English</a>
						<a href="?lang=">中文</a>
						<a href="?lang=">French</a>
						<a href="?lang=">Spanish</a>
						<a href="?lang=">Russian</a>
						<a href="?lang=">German</a>
						<a href="?lang=">Japanese</a>
					</div>
				</li>

			</ul>
		</nav>
		<!--导航条弹出框-->
		<div class="nav-info-box bg-gray opacity">

		</div>
		<div class="nav-info">

		</div>
		<!--中间的注册登录框-->
		<div id="snow-sign" class="bg-gray shadow">
			<div class="user-sign">
				<a href="javascript:;" class="getout icon-cancel-2 place-top-right margin5 fg-white border padding5" style="border-radius: 50%;">
				</a>
				<div class="padding20">
					<h3 class="padding10 fg-white">使用合作网站账户登录</h3>
					<div class="form-actions">
						<div class="horizontal-list">
							<ul>
								<li class="padding5 margin5 fg-white" id="qqLogin">QQ</li>
								<li class="padding5 margin5 fg-white">新浪微博(暂不可用)</li>
							</ul>
						</div>
					</div>
				</div>
				<hr />
				<div class="" data-load="signin">

				</div>
				<hr />
				<div class="" data-load="signup">

				</div>
				<hr />
				<div class="padding20 margin10">
					<button type="button" class="getout button primary large" style="width: 100%;font-weight: bold;">爷就这么任性</button>
				</div>
			</div>
		</div>
		{{.LayoutContent}}
		<!--滚动条-->
		<div id="scrollbar_vertical" class="mCSB_scrollTools mCSB_1_scrollbar mCS-minimal-dark mCSB_scrollTools_vertical" style="display: block;">
			<div class="mCSB_draggerContainer">
				<div id="dragger_vertical" class="mCSB_dragger" style="position: absolute; min-height: 50px; height: 416px; top: 49px; display: block; max-height: 455px;" oncontextmenu="return false;">
					<div class="mCSB_dragger_bar" style="line-height: 50px;"></div>
				</div>
				<div class="mCSB_draggerRail"></div>
			</div>
		</div>

	</body>

</html>
<script type="text/javascript">

	var snow = {
		speed: 300,
		width: $(window).width(),
		log: function() {
			console.log(arguments);
		},
		inc: function() {
			return '/static/inc/_' + arguments[0] + '.html';
		},
		go : function(url){
			window.location = url;
		},
		left: $('#snow-left'),
		scrollbar: $('#scrollbar_vertical'),
		account : {
			id:{{.account.Id}},
			nickName:$.cookie('nickname'),
			avatar:$.cookie('avatar'),
			openFrom:$.cookie('from'),
			accessToken:$.cookie('token')
		},
		//是否当期文档的作者
		owner:function(article){
			return article.data('creator') == snow.account.id;
		},
		checkin : function(u){
			if(u){
				var _avatar = $('#avatar').data('hint',u.nickName);
				_avatar.find('img').attr('src',u.avatar_1);
				_avatar.find('.nickname').text(u.nickName);

				snow.account.id = u.accoundId;

				$('.snow-profile',snow.right).show();
				$('#login').hide();
				return true;
			}else if($.cookie('_snow_token') && $.cookie('_snow_token').length){
				var _avatar = $('#avatar').data('hint',snow.account.nickName);
				_avatar.find('img').attr('src',snow.account.avatar);
				_avatar.find('.nickname').text(snow.account.nickName);
				$('.snow-profile',snow.right).show();
				$('#login').hide();
				return true;
			}else{
				$('.snow-profile',snow.right).hide();
				$('#login').show();
				return false;
			}
		},
		article:{}
	};

	snow.api = {
		signUp:'/signUp'
		,signIn:'/signIn'
		,signOut:'/signOut'
		,signTrace:'/connect/signtrace'
		,books:'/home/books'
		,mybooks:'/home/books/my'
		,catalog:'/home/catalog'
		,tags:'/home/tags'
		,content:'/home/content'
		,docSave:'/article/update'
		,docDelete:'/article/delete'
		,docPosition:'/article/position'
	};


	// 滚动条拖拽块事件
	snow.scrollbar.drager = snow.scrollbar.find('#dragger_vertical').draggable({
		axis: "y",
		containment: "parent",
		drag: function(e, ui) {
			var _this = $(this).css('left', 0).closest('.frame'),
				_height = _this.outerHeight(),
				_first = _this.find('>header'),
				_last = _this.find('>footer'),
				_maxHeight = Math.abs(parseInt(_first.css('marginTop'))) + _last.offset().top + _last.outerHeight(),
				_step = _height / _maxHeight,
				_top = ui.position.top / _step * (-1);

			_first.css({
				marginTop: _top
			});

			// 保存当前位置
			_this.data('position', _top);
		}
	});
	//隐藏位置
	snow.hidden = {
		left: -1000,
		right: -1000
	};
	//

	// 导航条
	snow.nav = {
		left: $('#nav-left'),
		right: $('#nav-right')
	};
	if(!snow.left.find('.snow-read').length){
		snow.nav.left.css('width',0);
	}
	snow.nav.left.width = snow.nav.left.width();
	snow.nav.right.width = snow.nav.right.width();
	//注册登录框
	snow.sign = $('#snow-sign').css({
		top:-2000,
		width: 400,
		right: snow.nav.right.width,
		left: snow.nav.left.width
	});

	/*
	 * 解决传统浏览器不支持placeholder问题
	 */
	function placeholder() {

		if (!('placeholder' in document.createElement('input'))) {

			$('input[placeholder],textarea[placeholder]').each(function() {

				var that = $(this),
					text = that.attr('placeholder');

				if (that.val() === "") {
					that.val(text).addClass('placeholder');
				}
				that.focus(function() {
					if (that.val() === text) {
						that.val("").removeClass('placeholder');
					}
				}).blur(function() {
					if (that.val() === "") {
						that.val(text).addClass('placeholder');
					}
				}).closest('form').submit(function() {
					if (that.val() === text) {
						that.val('');
					}
				});
			});
		}
	};
	/*
	 * 页面数据拉取
	 */
	function dataLoading() {
		$('[data-load]').each(function() {
			var _this = $(this),
				_data = _this.data('load');
			if (_data && _data.length > 0) {
				_this.load(snow.inc(_this.data('load')));
			}
		});
	};

	//打开登录注册框
	function openSign() {
		if (!snow.sign.hasClass('active')) {
			snow.sign.animate({
				top: 0
			}, snow.speed, function() {
				snow.sign.addClass('active');
			});
		}
	}

	//
	function open_login(u){
		snow.account.nickName = u.NickName;
		snow.account.gender = u.Gender;
		snow.account.avatar = u.Avatar_1;
		snow.account.openFrom = u.From;
		snow.account.openId = u.OpenId;
		snow.account.accessToken = u.Token;
		
		//console.log(u);		
		
		//记录登录状态
		$.post(snow.api.signTrace,{
			from:u.From,
			token:u.Token,
			openId:u.OpenId,
			nickName:u.NickName,
			gender:u.Gender,
			refresh:u.Refresh,
			avatar_1:u.Avatar_1,
			avatar_2:u.Avatar_2
		},function(d){
			if(d.ok){
				$(".getout").click();
				// 变更登录状态
				snow.checkin(d.data);
			}
		});
	};

	//
	$(window).resize(function() {
		// 窗体宽度
		snow.width = $(this).width();
		// // 书签
		// $('div.bookmarks').css({
		// 	top: (snow.nav.right.height() - 80) / 2
		// });
		// 左侧工作区
		snow.left.css({
			right: snow.nav.right.width,
			left: snow.nav.left.width
		});
		
		// 重绘工作区
		if(snow.left.find('.snow-index').length || snow.left.find('.snow-read').length){
			var _frames = snow.left.find('.frame'),_width = snow.left.width();
			if (_width < 2*600 && _frames.eq(0).width() < 600) {
				_frames.eq(0).css('width',600);
				_frames.eq(1).css({
					width:_width - 600,
					left:600
				})
			}else{
				_frames.css('width','50%');
				_frames.eq(1).css('left','50%');
			}
		}

		//
		snow.left.find('.frame').each(function(){
			var _this = $(this);
			_this.css({
				height: _this.parent().height()
			});
		});
	}).resize();


	setTimeout(function() {
		// 拉取数据
		dataLoading();
		// 解决传统浏览器不支持placeholder问题
		placeholder();

		//打开登录注册框
		if(!snow.checkin()){
			//openSign();
		}

	}, 100);

	// 左导航条---事件
	snow.nav.left.on('click', 'li', function(e) {
		var _that = $(this).addClass('active').siblings('.active').removeClass('active');
	});

	// 右导航条---事件
	// 语种选择
	$('#snow-lang').hover(
		function(){
			$('.snow-languages',this).animate({
				right:75
			});
		},
		function(){
			$('.snow-languages',this).animate({
				right:-552
			});
		}
	);
	// 登录 --- 事件
	$('#login').click(function(){
		openSign();
	});
	
	// 头像 --- 事件
	$('#avatar').click(function(){
		var _parentId = 0,
			_frame = snow.left.find('.frame.snow-me');
			
		if(!_frame.length){
			// 追加一个frame
			_frame = snow.chouti.appendFrame(_parentId).addClass('snow-me');
		}
		
		// 加载子节点
		$.post(snow.api.mybooks,{parentId:_parentId},function(result){
			if (result.ok) {
				snow.chouti.appendDoc(_frame,result.data);
			};
		});
	});
	
	snow.nav.right.on('click', 'li', function(e) {
		var _that = $(this);
		if (_that.data('rel') == 'signin') {
			
		} else {
//			//
//			$('div.nav-info').load(snow.inc(_that.data('rel')), function() {
//				$('div.nav-info-box').css({
//					width: $('div.nav-info').eq(0).width()
//				});
//			});
//			$('div.nav-info-box,div.nav-info').animate({
//				right: snow.nav.right.width
//			});
		}
	});

	// resize事件
	snow.autoScroll = function(_this) {
		//滚动条
		_this.append(snow.scrollbar);

		var _height = _this.outerHeight(),
			_first = _this.find('>header'),
			_last = _this.find('>footer'),
			_maxHeight = Math.abs(parseInt(_first.css('marginTop'))) + _last.offset().top + _last.outerHeight(),
			_step = _height / _maxHeight,
			_top = _this.data('position') || 0;

		if (_first === _last || _maxHeight <= _height) {
			snow.scrollbar.hide();
			_first.css({
				marginTop: 0
			});
			snow.scrollbar.drager.css({
				top: 0
			});
		} else {
			var _toTop = _height - _last.offset().top - _last.outerHeight()

			if (_toTop > 0) {
				_first.css('marginTop', '+=' + _toTop);
			} else {
				_first.css({
					marginTop: _top
				});
			}
			snow.scrollbar.show();
			snow.scrollbar.drager.css({
				maxHeight: _height,
				height: _height * _step,
				top: parseInt(_first.css('marginTop')) * _step * (-1)
			});
		}
		// 记录位置
		_this.data('position', _first.css('marginTop'));
	};

	// 滚动条事件
	snow.left.on('mousewheel', '.frame', function(e, delta) {
		// 只有滚动条才可滚动
		if (snow.scrollbar.is(':hidden')) {
			return;
		}
		var _this = $(this),
			_height = _this.outerHeight(),
			_first = _this.find('>header'),
			_last = _this.find('>footer'),
			_maxHeight = Math.abs(parseInt(_first.css('marginTop'))) + _last.offset().top + _last.outerHeight(),
			_step = _height / _maxHeight,
			_top = parseInt(_first.css('marginTop')) + (delta * 30);

		// 向上
		if (delta > 0 && _top > 0) {
			return;
		} else if (delta < 0 && parseInt(snow.scrollbar.drager.css('top')) + snow.scrollbar.drager.height() >= _height) {
			return;
		}

		_first.css({
			marginTop: _top
		});

		snow.scrollbar.drager.css({
			top: _top * _step * (-1)
		});
		// 保存当前位置
		_this.data('position', _top);

	}).on('mouseenter', '.frame', function(e) {
		// 刷新滚动条
		snow.autoScroll($(this));
	});
		
	//关闭登陆框
	$(".getout").click(function() {
		snow.sign
			.removeClass('active')
			.animate({
				top: '-2000px'
			}, snow.speed, function() {
				if (snow.nav.right.is(':hidden')) {
					snow.nav.right.animate({
						right: 0
					}, snow.speed).show();
				}
			});
	});

	$("#qqLogin").click(function() {
		window.open('/connect/qq_login','sign_dialog','width=600,height=420,menubar=no,scrollbars=yes, resizable=yes,status=yes,titlebar=no,toolbar=no,location=yes');
	});
	// 注销
	$('#logout').click(function(){
		$.post(snow.api.signOut,{},function(d){
			if (d.ok) {
				snow.go('/');
			}
		});
	});
	
	//
	// 通用方法，只要包含超链接href属性的，都转为超链接
	document.onclick = function(e){
		var _href = e.target.getAttribute('href');
		if(e.target.tagName.toLowerCase()!='a' && _href && _href.trim().length){
			var el = document.createElement("a"),_target = e.target.getAttribute('target');
			document.body.appendChild(el);
			el.href = _href; //url 是你得到的连接
			el.target = _target ? _target : ''; //指定在新窗口打开
			el.click();
			document.body.removeChild(el);
		}
	};

</script>