<style type="text/css">
	#snow-left .read .doc-content {
		cursor: pointer;
	}
	#tags .snow-catalog {
		text-indent: 2em;
	}
</style>
<!--左侧框--工作区-->
<div id="snow-left" class="bg-white">
	<div class="read" style="height:100%;">
		<div class="frame">
			<header>

			</header>

			<footer>

			</footer>
		</div>
		<div class="frame" style="left:50%;">
			<header>

			</header>
			<div id="catalog"></div>
			<footer>

			</footer>
		</div>
	</div>
</div>
<script type="text/javascript">
	$('#nav-left').css('width', 350);
	
	$(function() {
		// 文档模板
		snow.docTemplate = [];
		snow.docTemplate.push('<div id="doc-<%.id%>" class="doc" data-id="<%.id%>" data-parentid="<%.parentId%>" data-documentid="<%.documentId%>" data-creator="<%.creator%>">');
		snow.docTemplate.push('<header class="doc-handle"></header>');
		//			snow.docTemplate.push('<div class="doc-tools">');
		//				snow.docTemplate.push('<a href="javascript:;" title="修改" class="tools edit icon-pencil"></a>');
		//				snow.docTemplate.push('<a href="javascript:;" title="分支" class="tools del icon-github-6"></a>');
		//			snow.docTemplate.push('</div>');
		snow.docTemplate.push('<article class="doc-info">');
		snow.docTemplate.push('<div class="doc-content">');
		snow.docTemplate.push('<%.content%>');
		snow.docTemplate.push('</div>');
		//				snow.docTemplate.push('<div title="下级" class="doc-children doc-tools">');
		//				snow.docTemplate.push('<i class="icon-arrow-right-5"></i>');
		//				snow.docTemplate.push('</div>');
		snow.docTemplate.push('</article>');
		snow.docTemplate.push('<footer class="text-center">');
		snow.docTemplate.push('<div class="pos-abs">');
		snow.docTemplate.push('<span class="doc-remark"></span>');
		snow.docTemplate.push('</div>');
		snow.docTemplate.push('<div class="doc-tools">');
		snow.docTemplate.push('<span class="tools icon-eye"><i>123</i></span>');
		snow.docTemplate.push('<span class="tools icon-new-tab"><i>456</i></span>');
		snow.docTemplate.push('<span class="tools icon-thumbs-up"><i>123</i></span>');
		snow.docTemplate.push('<span class="tools icon-github-6"><i>123</i></span>');
		snow.docTemplate.push('</div>');
		//				snow.docTemplate.push('<a href="javascript:;" class="doc-plus">在下面<i class="icon-plus on-right on-left"></i>新建</a>');
		snow.docTemplate.push('</footer>');
		snow.docTemplate.push('</div>');
		snow.docTemplate.push('<div></div>');
		snow.docTemplate.get = function(doc) {
			return $(this.join('').replace(/<%.id%>/g, doc.articleId)
				.replace(/<%.parentId%>/g, doc.parentId)
				.replace(/<%.creator%>/g, doc.creator)
				.replace(/<%.documentId%>/g, doc.documentId)
				.replace(/<%.content%>/g, doc.content)).data('content', doc.content);
		};
		/* 增加单个文档
		 * frame:容器
		 * doc:文档
		 * before:文档位置，true表示最前，false表示最后
		 */
		snow.addDoc = function(frame, doc, before) {
			if (before) {
				frame.find('>header').after(doc);
			} else {
				frame.find('>footer').before(doc);
			}
		};
		// 加载目录
		$.post(snow.api.catalog, {parentId:'{{.parentId}}'}, function(result) {
			if (result.ok) {
				var _docs = result.data,
					_catalog = $('#tags').empty(),
					_tpl = function(_d, one) {
						return '<div id="title-<%.id%>" class="<%.class%>"><div class="snow-catalog-item" data-id="<%.id%>"><%.title%></div></div>'
							.replace(/<%.id%>/g, _d.articleId)
							.replace(/<%.title%>/g, _d.title)
							.replace(/<%.class%>/g, (one ? '' : 'snow-catalog'))
					};
				$.each(_docs, function(index, _d) {
					if (_d.title == '') {
						return;
					}
					if (_d.parentId == '{{.parentId}}') {
						_catalog.append(_tpl(_d, true));
					} else {
						$('#title-' + _d.parentId).append(_tpl(_d));
					}
				});
			};
		});
		// 首次加载内容
		$.post(snow.api.content, {parentId:'{{.parentId}}'}, function(result) {
			if (result.ok) {
				var _docs = result.data
					,_frame = snow.left.find('.frame').eq(0).data('parentid', 0);
				
				$.each(_docs, function(index, _doc) {
					if (_doc.parentId == '{{.parentId}}') {
						snow.addDoc(
							_frame, snow.docTemplate.get(_doc)
						);
					} else {
						$('#doc-' + _doc.parentId).next().append(snow.docTemplate.get(_doc));
					}
				});
				// 代码高亮
				SyntaxHighlighter.highlight();
				// 定位到指定的节点（章节）
				snow.moveToArticle('{{.articleId}}');
			};
		});
		
		// 目录事件
		$('#tags').on('click','.snow-catalog-item',function(){
			// 定位到指定的节点（章节）
			snow.moveToArticle($(this).data('id'));
		});
		
		// 定位到指定节点（章节）
		snow.moveToArticle = function(articleId){
			// 无效节点，跳过
			if(!$('#doc-'+articleId).length){
				return;
			}
			
			var _frame = snow.left.find('.frame').eq(0)
				,_first = _frame.find('>header')
				,_last = _frame.find('>footer')
				,_top = parseInt(_first.css('marginTop')) - $('#doc-'+articleId).offset().top;
				
			// 防止漏出"底裤"
			if(_frame.innerHeight() > _last.offset().top - $('#doc-'+articleId).offset().top){
				_top = _top + _frame.innerHeight() - (_last.offset().top - $('#doc-'+articleId).offset().top);
			}

			_first.animate({
				marginTop: _top
			},function(){
				// 保存当前位置
				_frame.data('position', _top);
				// 刷新滚动条
				snow.autoScroll(_frame);
			});	

			// 重绘目录
			$('#tags').find('.snow-catalog-item.active').removeClass('active');
			$('#title-'+articleId+' > .snow-catalog-item').addClass('active');
		};
	});
</script>