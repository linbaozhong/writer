<!--左侧框--工作区-->
<div id="snow-left" class="bg-white">
	<div class="chouti" style="height:100%;">
		<div class="frame">
			<header>
				<form class="doc user-input native" style="display:none;">
					<input type="hidden" name="id" id="doc-id" value="" />
					<script id="myEditor" name="content" type="text/plain">

					</script>
					<!--<div class="input-control textarea">
						<textarea id="myEditor" name="content" rows="" cols="" placeholder="写点儿什么……"></textarea>
					</div>-->
					<!--<div class="form-actions input-control text">
						<input type="text" name="tags" id="tags" value="" placeholder="标签" />
					</div>-->
					<div class="form-actions text-right" style="margin-top: 10px;">
						<button name="btn-save" type="button" data-role="0" class="button primary">保存</button>
						<button name="btn-cancel" type="button" data-role="0" class="button">取消</button>
					</div>
				</form>
				<div class="doc-add text-center padding20">
					<a href="javascript:;" class="doc-plus">新<i class="icon-plus on-right on-left"></i>建</a>
				</div>
			</header>

			<div class="doc" data-id="1">
				<div class="doc-tools">
					<a href="javascript:;" class="tools edit icon-pencil">
					</a>
					<a href="javascript:;" class="tools del icon-cancel-2">
					</a>
				</div>
				<article class="doc-info">
					<div class="doc-content">
						<h2>



					标题标题标题标题标题标题



				</h2>
						<p>正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文</p>
					</div>
				</article>
				<footer class="text-center">
					<div class="pos-abs">
						<span class="doc-remark"></span>
					</div>
					<div class="doc-tools">
						<span class="tools icon-new-tab"><i>456</i></span>
						<span class="tools icon-heart-2"><i>123</i></span>
					</div>
					<a href="javascript:;" class="doc-plus">在下面<i class="icon-plus on-right on-left"></i>新建</a>
				</footer>
			</div>
			<div class="doc">
				<div class="doc-tools">
					<a href="javascript:;" class="tools edit icon-pencil">
					</a>
					<a href="javascript:;" class="tools del icon-cancel-2">
					</a>
				</div>
				<article class="doc-info">
					<div class="doc-content">
						<h2>



					标题标题标题标题标题标题



				</h2>
						<p>正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文</p>
					</div>
				</article>
				<footer class="text-center">
					<div class="pos-abs">
						<span class="doc-remark"></span>
					</div>
					<div class="doc-tools">
						<span class="tools icon-new-tab"><i>456</i></span>
						<span class="tools icon-heart-2"><i>123</i></span>
					</div>
					<a href="javascript:;" class="doc-plus">在下面<i class="icon-plus on-right on-left"></i>新建</a>
				</footer>
			</div>
			<div class="doc">
				<div class="doc-tools">
					<a href="javascript:;" class="tools edit icon-pencil">
					</a>
					<a href="javascript:;" class="tools del icon-cancel-2">
					</a>
				</div>
				<article class="doc-info">
					<div class="doc-content">
						<h3>



					标题标题标题标题标题标题



				</h3>
						<p>正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文</p>
					</div>
				</article>
				<footer class="text-center">
					<div class="pos-abs">
						<span class="doc-remark"></span>
					</div>
					<div class="doc-tools">
						<span class="tools icon-new-tab"><i>456</i></span>
						<span class="tools icon-heart-2"><i>123</i></span>
					</div>
					<a href="javascript:;" class="doc-plus">在下面<i class="icon-plus on-right on-left"></i>新建</a>
				</footer>
			</div>
			<div class="doc">
				<div class="doc-tools">
					<a href="javascript:;" class="tools edit icon-pencil">
					</a>
					<a href="javascript:;" class="tools del icon-cancel-2">
					</a>
				</div>
				<article class="doc-info">
					<div class="doc-content">
						<h3>



					1111111111111111111111111111111



				</h3>
						<p>正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文</p>
					</div>
				</article>
				<footer class="text-center">
					<div class="pos-abs">
						<span class="doc-remark"></span>
					</div>
					<div class="doc-tools">
						<span class="tools icon-new-tab"><i>456</i></span>
						<span class="tools icon-heart-2"><i>123</i></span>
					</div>
					<a href="javascript:;" class="doc-plus">在下面<i class="icon-plus on-right on-left"></i>新建</a>
				</footer>
			</div>
			<div class="doc">
				<div class="doc-tools">
					<a href="javascript:;" class="tools edit icon-pencil">
					</a>
					<a href="javascript:;" class="tools del icon-cancel-2">
					</a>
				</div>
				<article class="doc-info">
					<div class="doc-content">
						<h3>



					2222222222222222222222222



				</h3>
						<p>正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文</p>
					</div>
				</article>
				<footer class="text-center">
					<div class="pos-abs">
						<span class="doc-remark"></span>
					</div>
					<div class="doc-tools">
						<span class="tools icon-new-tab"><i>456</i></span>
						<span class="tools icon-heart-2"><i>123</i></span>
					</div>
					<a href="javascript:;" class="doc-plus">在下面<i class="icon-plus on-right on-left"></i>新建</a>
				</footer>
			</div>
			<div class="doc">
				<div class="doc-tools">
					<a href="javascript:;" class="tools edit icon-pencil">
					</a>
					<a href="javascript:;" class="tools del icon-cancel-2">
					</a>
				</div>
				<article class="doc-info">
					<div class="doc-content">
						<h3>



					3333



				</h3>
						<p>正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文</p>
					</div>
				</article>
				<footer class="text-center">
					<div class="pos-abs">
						<span class="doc-remark"></span>
					</div>
					<div class="doc-tools">
						<span class="tools icon-new-tab"><i>456</i></span>
						<span class="tools icon-heart-2"><i>123</i></span>
					</div>
					<a href="javascript:;" class="doc-plus">在下面<i class="icon-plus on-right on-left"></i>新建</a>
				</footer>
			</div>
			<div class="doc">
				<div class="doc-tools">
					<a href="javascript:;" class="tools edit icon-pencil">
					</a>
					<a href="javascript:;" class="tools del icon-cancel-2">
					</a>
				</div>
				<article class="doc-info">
					<div class="doc-content">
						<h3>



					44444444444



				</h3>
						<p>正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文正文</p>
					</div>
				</article>
				<footer class="text-center">
					<div class="pos-abs">
						<span class="doc-remark"></span>
					</div>
					<div class="doc-tools">
						<span class="tools icon-new-tab"><i>456</i></span>
						<span class="tools icon-heart-2"><i>123</i></span>
					</div>
					<a href="javascript:;" class="doc-plus">在下面<i class="icon-plus on-right on-left"></i>新建</a>
				</footer>
			</div>
			<footer>
				<div class="mask" />
			</footer>
		</div>
	</div>
</div>
<!--书签-->
<!--<div class="bookmarks bookmarks-left bg-gray">
	<h1>
	<i class="icon-arrow-left-3 fg-white"></i></h1>
</div>
<div class="bookmarks bookmarks-right bg-gray">
	<h1>
	<i class="icon-arrow-right-3 fg-white"></i></h1>
</div>-->
<script type="text/javascript">
$(function(){
	// accordion插件
	snow.chouti = snow.left.find('div.chouti').accordion({
		horizontal: true
	});
	// resize事件
	snow.docResize = function(_this) {
		//滚动条
		_this.append(snow.scrollbar);

		var _height = _this.outerHeight(),
			_first = _this.find('>header'),
			_last = _this.find('>footer'),
			_maxHeight = Math.abs(parseInt(_first.css('marginTop'))) + _last.offset().top + _last.outerHeight(),
			_step = _height / _maxHeight,
			_top = _this.data('position') || 0;

		if (_first === _last || _maxHeight <= _height) {
			snow.scrollbar.hide();
			_first.css({
				marginTop: 0
			});
			snow.scrollbar.drager.css({
				top: 0
			});
		} else {
			var _toTop = _height - _last.offset().top - _last.outerHeight()

			if (_toTop > 0) {
				_first.css('marginTop', '+=' + _toTop);
			} else {
				_first.css({
					marginTop: _top
				});
			}
			snow.scrollbar.show();
			snow.scrollbar.drager.css({
				maxHeight: _height,
				height: _height * _step,
				top: parseInt(_first.css('marginTop')) * _step * (-1)
			});
		}
		// 记录位置
		_this.data('position', _first.css('marginTop'));
	};

	// 文档编辑框
	snow.editor = snow.left.find('form.native').eq(0).click(function(e) {
		if (snow.left.find('form.editing').length) {
			return;
		}
		var _form = $(this);
		if (_form.hasClass('editing') && _form.find('textarea').val() == '') {} else if (!_form.hasClass('editing')) {
			_form.addClass('editing').slideDown(function() {
				snow.docResize(_form.closest('.frame'));
			});
		}
	}).on('click', 'button', function(e) { //表单保存(取消)事件
		e.stopPropagation();
		var _that = $(this),
			_form = _that.closest('form.user-input'),
			_frame = _form.closest('.frame'),
			_id = _form.find('input[name="id"]').val(),
			_content = snow.ue.getContent();

		if (_that.attr('name') == 'btn-save') { //保存
			$.post(snow.api.docSave
				,{id:_id,content:_content}
				,function(result){
				snow.log(result);
			});
			var __doc = _form.prev('div.doc');
			
			// 新建文档
			if ($.trim(_id).length) {
				// 在_form之前插入一个新doc
			} else {
				// 编辑修改，修改form之前的doc
				__doc.find('.doc-content').html(_content);
			}
		} else { //取消

		}
		// 复原
		_form.removeClass('editing').slideUp(snow.speed, function() {
			// 顶端新增按钮
			if (_form.prev('div.doc-add').length) {
				_form.prev('div.doc-add').fadeIn(function() {
					snow.docResize(_frame);
				});
			} else if (_form.prev('div.doc').length) {
				_form.prev('div.doc').fadeIn(function() {
					snow.docResize(_frame);
				});
			} else {
				snow.docResize(_frame);
			}
		}).find('textarea').val('');
	});
	/* 增加单个文档
	 * frame:容器
	 * doc:文档
	 * before:文档位置，true表示最前，false表示最后
	 */
	snow.addDoc = function(frame, doc, before) {
		if (before) {
			frame.find('>header').after(doc);
		} else {
			frame.find('>footer').before(doc);
		}
	}

	//
	snow.left.on('mousewheel', '.frame', function(e, delta) {
		// 只有滚动条才可滚动
		if (snow.scrollbar.is(':hidden')) {
			return;
		}
		var _this = $(this),
			_height = _this.outerHeight(),
			_first = _this.find('>header'),
			_last = _this.find('>footer'),
			_maxHeight = Math.abs(parseInt(_first.css('marginTop'))) + _last.offset().top + _last.outerHeight(),
			_step = _height / _maxHeight,
			_top = parseInt(_first.css('marginTop')) + (delta * 20);

		// 向上
		if (delta > 0 && _top > 0) {
			return;
		} else if (delta < 0 && parseInt(snow.scrollbar.drager.css('top')) + snow.scrollbar.drager.height() >= _height) {
			return;
		}

		_first.css({
			marginTop: _top
		});

		snow.scrollbar.drager.css({
			top: _top * _step * (-1)
		});
		// 保存当前位置
		_this.data('position', _top);

	}).on('mouseenter', '.frame', function(e) {
		// 刷新滚动条
		snow.docResize($(this));
	}).on('click', '.frame div.doc', function(e) {
		e.stopPropagation();
		var _doc = $(this);

		// 追加一个frame
		if (!_doc.closest('.frame').next().length) {
			snow.chouti.add({
				title: '',
				url: 'it.htm',
				active: false
			}, function(frame) {
				frame.prepend('<footer><div class="mask" /></footer>');
				//frame.prepend($('<header />').append(snow.editor.clone(true)));
				frame.prepend(
					$('<header />').append('<div class="doc-add text-center padding20">' + '<a href="javascript:;" class="doc-plus">新<i class="icon-plus on-right on-left"></i>建</a>' + '</div>')
				);
				frame.find('.mask').css({
					width: frame.outerWidth(),
					height: frame.outerHeight()
				});
			});
		}
		// 复原编辑表单
		if (!_doc.hasClass('active')) {
			_doc.siblings('.active').removeClass('active');

			// 激活doc
			_doc.addClass('active');

		}

	}).on('click', '.frame .tools.del', function(e) {
		e.stopPropagation();
		var _doc = $(this).closest('div.doc');

		if (_doc.next().hasClass('clone')) {
			_doc.next().hide();
		}

		_doc.remove();
		//
		snow.docResize(_doc.closest('.frame'));
	}).on('click', '.frame .doc .tools.edit', function(e) {
		e.stopPropagation();
		// 如果有仍未提交的正在编辑中的表单，中断当前操作
		if (snow.left.find('form.editing').length > 0) {
			return;
		}

		var _doc = $(this).closest('div.doc').hide();
		// 赋值
		snow.editor.find('input[name="id"]').val(_doc.data('id'));

		_doc.after(snow.editor.click().slideDown(snow.speed, function() {
			snow.ue.setContent(_doc.find('.doc-content').html());
		}));

	}).on('click', '.frame .doc .doc-plus', function(e) {
		e.stopPropagation();
		// 如果有仍未提交的正在编辑中的表单，中断当前操作
		if (snow.left.find('form.editing').length) {
			return;
		}

		var _doc = $(this).closest('div.doc');
		if (!_doc.next().hasClass('clone')) {
			snow.editor.find('textarea').val('');
			_doc.after(snow.editor);
		}

		// 赋值
		snow.editor.find('input[name="id"]').val('');
		snow.ue.setContent('');

		snow.editor.click().slideDown(snow.speed);
	}).on('click', '.frame header .doc-plus', function(e) {
		e.stopPropagation();
		// 如果有仍未提交的正在编辑中的表单，中断当前操作
		if (snow.left.find('form.editing').length) {
			return;
		}

		var _doc = $(this).parent().hide().closest('header');

		// 赋值
		snow.editor.find('input[name="id"]').val('');
		snow.ue.setContent('');

		_doc.append(snow.editor.click().slideDown(snow.speed));
	});

	// 选中第一个文档
	//snow.left.find('.frame div.doc').eq(0).click();

	// // 书签事件
	// $('div.bookmarks').hover(
	// 	function() {
	// 		$(this).css('opacity', 0.8);
	// 	},
	// 	function() {
	// 		$(this).css('opacity', 0.1);
	// 	}
	// );
});
</script>